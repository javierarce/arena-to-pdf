#!/usr/bin/env ruby

require 'arena'
require 'open-uri'
require 'dotenv/load'
require 'fileutils'
require 'uri'

PDF_EXTENSION = 'pdf'

class ArenaDownloader

  attr_accessor :url

  def initialize(url, dir)
    @per_page = 100
    @url = url
    @channel = nil
    @dirname = dir || ENV['PDF_FOLDER_PATH']
  end

  def showMessage(message, color = '32')
    puts "\033[#{color}m#{message}\033[0m" 
  end

  def showInfo(message)
    showMessage(message)
  end

  def showError(message)
    showMessage(message, 31)
  end

  def login
    Arena.configure do |config|
      config.access_token = ENV['ACCESS_TOKEN']
    end
  end

  def sanitize_filename(filename)
    filename.gsub('/', ' ')
  end

  def start
    login

    slug = URI(@url).path.split('/').last

    begin
      @channel = Arena.channel(slug, { page: 0, per: @per_page })
      blocksCount = @channel.length

      extraPage = blocksCount % @per_page == 0 ?  0 : 1
      pagesCount = (blocksCount / @per_page) + extraPage

      showInfo("Downloading from #{blocksCount} #{blocksCount == 1 ? 'block' : 'blocks'} / #{@channel.title}")

      createDirectory

      pagesCount.times do |c|
        page = c + 1
        @channel = Arena.channel(slug, { page: page, per: @per_page })
        download(@channel.contents, page, pagesCount)
        sleep 5
      end

    rescue Exception => e
      showError("Channel not found #{e}")
    end
  end

  def createDirectory
    @dirname = @dirname ? "#{@dirname}/#{@channel.title}" : "#{PDF_EXTENSION}/#{@channel.title}"

    unless Dir.exists?(@dirname)
      FileUtils.mkdir_p(@dirname) 
    end
  end

  def downloadAttachment(title, attachment, page, index, total)
    puts "\033[34m#{index}/#{total}\033[0m \033[31m#{title}\033[0m" 

    filename = "#{@dirname}/#{sanitize_filename title}"
    filename += ".#{PDF_EXTENSION}" unless title.end_with? ".#{PDF_EXTENSION}"

    unless File.exist?(filename)
      open(filename, 'wb') do |file|
        file << open(attachment.url).read
      end
      sleep 2
    end
  end

  def download(content, page, pagesCount)
    connectables = content.select do |c|
      c if c.respond_to?(:attachment) and c.attachment and c.attachment.extension === 'pdf'
    end

    if connectables.length === 0
      showError("#{@channel.title} doesn't contain any PDF ")
      return
    end

    showInfo("\nPage #{page} of #{pagesCount}\n")

    connectables.each_with_index do |c, index| 
      downloadAttachment(c.title, c.attachment, page, index + 1, connectables.length)
    end 
  end
end

if ARGV[0].nil?
  puts 'Command syntax: ./download CHANNEL_URL [PDF_FOLDER_PATH]'
else
  downloader = ArenaDownloader.new(ARGV[0], ARGV[1])
  downloader.start
end
